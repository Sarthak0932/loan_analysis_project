# Create new features
print("Creating new features...")

# 1. Credit utilization ratio
if 'revol_bal' in df_clean.columns and 'revol_util' in df_clean.columns:
    df_clean['credit_utilization'] = df_clean['revol_util']

# 2. Income to loan ratio
if 'annual_inc' in df_clean.columns and 'loan_amnt' in df_clean.columns:
    df_clean['income_to_loan_ratio'] = df_clean['annual_inc'] / (df_clean['loan_amnt'] + 1)

# 3. Credit history length (in years)
if 'earliest_cr_line' in df_clean.columns and 'issue_d' in df_clean.columns:
    df_clean['credit_history_years'] = (
        (df_clean['issue_d'] - df_clean['earliest_cr_line']).dt.days / 365.25
    )

# 4. FICO score average
if 'fico_range_low' in df_clean.columns and 'fico_range_high' in df_clean.columns:
    df_clean['fico_score_avg'] = (df_clean['fico_range_low'] + df_clean['fico_range_high']) / 2

# 5. Total payment ratio (how much was paid vs loan amount)
if 'total_pymnt' in df_clean.columns and 'loan_amnt' in df_clean.columns:
    df_clean['payment_ratio'] = df_clean['total_pymnt'] / (df_clean['loan_amnt'] + 1)

# 6. Loan status binary (default vs non-default)
if 'loan_status' in df_clean.columns:
    default_statuses = ['Charged Off', 'Default', 'Late (31-120 days)', 'Late (16-30 days)']
    df_clean['is_default'] = df_clean['loan_status'].isin(default_statuses).astype(int)

# 7. Employment length in years
if 'emp_length' in df_clean.columns:
    df_clean['emp_length_years'] = df_clean['emp_length'].replace({
        '< 1 year': 0, '1 year': 1, '2 years': 2, '3 years': 3, '4 years': 4,
        '5 years': 5, '6 years': 6, '7 years': 7, '8 years': 8, '9 years': 9,
        '10+ years': 10, 'n/a': np.nan
    })

print("Feature engineering completed!")
print(f"\nNew features created: {['income_to_loan_ratio', 'credit_history_years', 'fico_score_avg', 'payment_ratio', 'is_default', 'emp_length_years']}")
# Select numerical features for correlation analysis
numerical_features = ['loan_amnt', 'funded_amnt', 'int_rate', 'installment', 'annual_inc', 
                      'dti', 'open_acc', 'total_acc', 'revol_bal', 'revol_util',
                      'fico_score_avg', 'income_to_loan_ratio', 'credit_history_years',
                      'payment_ratio', 'emp_length_years', 'is_default']

# Filter to only include columns that exist in the dataframe
numerical_features = [col for col in numerical_features if col in df_clean.columns]

# Calculate correlation matrix
correlation_matrix = df_clean[numerical_features].corr()

# Plot correlation heatmap
plt.figure(figsize=(14, 10))
sns.heatmap(correlation_matrix, annot=True, fmt='.2f', cmap='coolwarm', center=0,
            square=True, linewidths=0.5, cbar_kws={"shrink": 0.8})
plt.title('Correlation Matrix of Key Features', fontsize=16, fontweight='bold', pad=20)
plt.tight_layout()
plt.show()
# Analyze correlations with default status
if 'is_default' in df_clean.columns:
    default_correlations = correlation_matrix['is_default'].sort_values(ascending=False)
    
    print("Top features correlated with loan default:")
    print("="*50)
    print(default_correlations.head(15))
    
    # Visualize top correlations with default
    plt.figure(figsize=(10, 6))
    top_corr = default_correlations.drop('is_default').head(10)
    colors = ['red' if x < 0 else 'green' for x in top_corr.values]
    plt.barh(range(len(top_corr)), top_corr.values, color=colors, alpha=0.7, edgecolor='black')
    plt.yticks(range(len(top_corr)), top_corr.index)
    plt.xlabel('Correlation Coefficient')
    plt.title('Top 10 Features Correlated with Loan Default', fontsize=14, fontweight='bold')
    plt.axvline(x=0, color='black', linestyle='--', linewidth=1)
    plt.grid(alpha=0.3, axis='x')
    plt.tight_layout()
    plt.show()
# Relationship between key features and default status
if 'is_default' in df_clean.columns:
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    
    # Interest rate vs Default
    if 'int_rate' in df_clean.columns:
        df_clean.groupby('is_default')['int_rate'].plot(kind='hist', alpha=0.6, 
                                                         bins=30, ax=axes[0, 0], legend=True)
        axes[0, 0].set_title('Interest Rate Distribution by Default Status', fontsize=12, fontweight='bold')
        axes[0, 0].set_xlabel('Interest Rate')
        axes[0, 0].legend(['Not Default', 'Default'])
    
    # DTI vs Default
    if 'dti' in df_clean.columns:
        df_clean.groupby('is_default')['dti'].plot(kind='hist', alpha=0.6, 
                                                    bins=30, ax=axes[0, 1], legend=True)
        axes[0, 1].set_title('DTI Distribution by Default Status', fontsize=12, fontweight='bold')
        axes[0, 1].set_xlabel('Debt-to-Income Ratio')
        axes[0, 1].legend(['Not Default', 'Default'])
    
    # FICO score vs Default
    if 'fico_score_avg' in df_clean.columns:
        df_clean.groupby('is_default')['fico_score_avg'].plot(kind='hist', alpha=0.6, 
                                                               bins=30, ax=axes[1, 0], legend=True)
        axes[1, 0].set_title('FICO Score Distribution by Default Status', fontsize=12, fontweight='bold')
        axes[1, 0].set_xlabel('FICO Score')
        axes[1, 0].legend(['Not Default', 'Default'])
    
    # Annual Income vs Default (log scale)
    if 'annual_inc' in df_clean.columns:
        df_clean['log_annual_inc'] = np.log10(df_clean['annual_inc'] + 1)
        df_clean.groupby('is_default')['log_annual_inc'].plot(kind='hist', alpha=0.6, 
                                                               bins=30, ax=axes[1, 1], legend=True)
        axes[1, 1].set_title('Annual Income Distribution by Default Status (Log)', fontsize=12, fontweight='bold')
        axes[1, 1].set_xlabel('Log10(Annual Income)')
        axes[1, 1].legend(['Not Default', 'Default'])
    
    plt.tight_layout()
    plt.show()

